name: ðŸ¤– Auto Refresh YouTube Cookies

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at 00:00 UTC
  workflow_dispatch:     # Manual trigger

jobs:
  refresh:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Cache playwright browsers
      uses: actions/cache@v3
      with:
        path: /home/runner/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-cookies
        restore-keys: |
          ${{ runner.os }}-playwright-
    
    - name: Install dependencies
      run: |
        pip install playwright
        playwright install chromium
        playwright install-deps
    
    - name: Refresh YouTube cookies
      id: refresh
      env:
        YOUTUBE_EMAIL: ${{ secrets.YOUTUBE_EMAIL }}
        YOUTUBE_PASSWORD: ${{ secrets.YOUTUBE_PASSWORD }}
      run: |
        cat > refresh_cookies.py << 'EOF'
import asyncio
import os
import sys
from playwright.async_api import async_playwright

async def refresh_youtube_cookies():
    """Automatically refresh YouTube cookies"""
    email = os.getenv('YOUTUBE_EMAIL')
    password = os.getenv('YOUTUBE_PASSWORD')
    
    if not email or not password:
        print("âŒ YOUTUBE_EMAIL or YOUTUBE_PASSWORD not set")
        return None
    
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True, args=['--disable-blink-features=AutomationControlled'])
        context = await browser.new_context(
            viewport={'width': 1280, 'height': 720},
            user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        )
        page = await context.new_page()
        
        try:
            # Navigate to YouTube
            print("ðŸŒ Opening YouTube...")
            await page.goto('https://www.youtube.com', wait_until='networkidle')
            
            # Check if already logged in
            try:
                await page.wait_for_selector('a[aria-label="Create"]', timeout=5000)
                print("âœ… Already logged in!")
            except:
                print("ðŸ” Not logged in, signing in...")
                
                # Click sign in button
                try:
                    sign_in_button = page.locator('a:has-text("Sign in")')
                    await sign_in_button.click()
                except:
                    # Try alternative selector
                    await page.click('a[href*="accounts.google.com"]')
                
                await page.wait_for_load_state('networkidle')
                
                # Enter email
                print(f"ðŸ“§ Entering email...")
                try:
                    email_input = page.locator('input[type="email"]')
                    await email_input.fill(email)
                    await page.press('input[type="email"]', 'Enter')
                except Exception as e:
                    print(f"âš ï¸ Email input error: {e}")
                
                await page.wait_for_timeout(2000)
                
                # Enter password
                print("ðŸ”‘ Entering password...")
                try:
                    password_input = page.locator('input[type="password"]')
                    await password_input.fill(password)
                    await page.press('input[type="password"]', 'Enter')
                except Exception as e:
                    print(f"âš ï¸ Password input error: {e}")
                
                # Wait for redirect
                print("â³ Waiting for authentication...")
                try:
                    await page.wait_for_url('**/youtube.com/**', timeout=15000)
                    await page.wait_for_load_state('networkidle')
                except:
                    print("âš ï¸ May need 2FA - waiting longer...")
                    await page.wait_for_timeout(5000)
            
            # Get cookies
            print("ðŸª Extracting cookies...")
            cookies = await context.cookies()
            
            if not cookies:
                print("âŒ No cookies found!")
                return None
            
            # Convert to Netscape format
            netscape_cookies = convert_to_netscape_format(cookies)
            
            # Save to file
            with open('youtube_cookies_new.txt', 'w') as f:
                f.write(netscape_cookies)
            
            # Output for GitHub Actions
            print(f"âœ… Success! Extracted {len(cookies)} cookies")
            with open('/tmp/cookies_output.txt', 'w') as f:
                f.write(netscape_cookies)
            
            return True
        
        except Exception as e:
            print(f"âŒ Error: {e}")
            import traceback
            traceback.print_exc()
            return False
        finally:
            await browser.close()

def convert_to_netscape_format(cookies):
    """Convert Playwright cookies to Netscape format"""
    lines = [
        '# Netscape HTTP Cookie File',
        '# This file was generated by auto_refresh_cookies workflow',
        '# Do not edit directly!',
        ''
    ]
    
    for cookie in cookies:
        # Skip session cookies without expiry
        if not cookie.get('expires'):
            continue
        
        # Netscape format: domain flag path secure expiry name value
        line = '\t'.join([
            cookie.get('domain', ''),
            'TRUE' if cookie.get('domain', '').startswith('.') else 'FALSE',
            cookie.get('path', '/'),
            'TRUE' if cookie.get('secure', False) else 'FALSE',
            str(int(cookie.get('expires', 0))),
            cookie.get('name', ''),
            cookie.get('value', '')
        ])
        lines.append(line)
    
    return '\n'.join(lines)

if __name__ == '__main__':
    result = asyncio.run(refresh_youtube_cookies())
    sys.exit(0 if result else 1)
EOF
        python refresh_cookies.py
    
    - name: Check cookies extracted
      run: |
        if [ -f youtube_cookies_new.txt ]; then
          LINES=$(wc -l < youtube_cookies_new.txt)
          echo "âœ… Cookies file created with $LINES lines"
          head -20 youtube_cookies_new.txt
        else
          echo "âŒ Cookies file not found!"
          exit 1
        fi
    
    - name: Update GitHub Secret with new cookies
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Read the cookies file
        COOKIES=$(cat youtube_cookies_new.txt)
        
        # Use GitHub CLI to update secret
        echo "$COOKIES" | gh secret set YOUTUBE_COOKIES_TXT --body -
        
        echo "âœ… GitHub Secret updated successfully!"
        echo "Lines in secret: $(echo "$COOKIES" | wc -l)"
    
    - name: Upload cookies as artifact
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: youtube-cookies-backup
        path: youtube_cookies_new.txt
        retention-days: 7
    
    - name: Notify Telegram on Success
      if: success()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
      run: |
        if [[ -z "$TELEGRAM_TOKEN" || -z "$TELEGRAM_TO" ]]; then
          echo "âš ï¸  Telegram secrets not set, skipping notification"
          exit 0
        fi
        
        MESSAGE="âœ… YouTube cookies successfully refreshed!%0A%0AWorkflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_TO \
          -d text="$MESSAGE" \
          -d parse_mode="HTML" || echo "âš ï¸  Telegram notification failed"
    
    - name: Notify Telegram on Failure
      if: failure()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
      run: |
        if [[ -z "$TELEGRAM_TOKEN" || -z "$TELEGRAM_TO" ]]; then
          exit 0
        fi
        
        MESSAGE="âŒ YouTube cookies refresh FAILED!%0A%0ACheck: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_TO \
          -d text="$MESSAGE" \
          -d parse_mode="HTML" || true
