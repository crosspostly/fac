name: Rutube Sync Bot

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */3 * * *'  # Run every 3 hours
  workflow_dispatch:       # Allow manual run button

permissions:
  contents: write          # Allow committing back to repo

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1
      PIP_NO_INPUT: 1
      DENO_DIR: /home/runner/.deno
      PLAYWRIGHT_BROWSERS_PATH: /home/runner/.cache/ms-playwright

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    # ========== AGGRESSIVE CACHING START ==========

    - name: Setup Deno
      uses: denoland/setup-deno@v2
      with:
        deno-version: v1.x

    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: /home/runner/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg xvfb

    # ========== PYTHON DEPENDENCIES ==========

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install --prefer-binary -r requirements.txt
        # Always ensure yt-dlp is latest to avoid YouTube signature issues
        python -m pip install --upgrade yt-dlp

    # ========== PLAYWRIGHT SETUP ==========

    - name: Install Playwright Chromium
      run: |
        python -m playwright install chromium

    - name: Install Playwright system dependencies
      run: |
        # Fix: Use the specific python executable that has playwright installed
        sudo $(which python) -m playwright install-deps chromium

    - name: Verify Playwright
      run: |
        python -c "from playwright.sync_api import sync_playwright; print('âœ… Playwright OK')"

    # ========== CACHING END ==========

    - name: Restore Secrets (Config & Cookies)
      env:
        RUTUBE_COOKIES: ${{ secrets.RUTUBE_COOKIES_JSON }}
        TIKTOK_COOKIES: ${{ secrets.TIKTOK_COOKIES_TXT }}
        YT_COOKIES: ${{ secrets.YOUTUBE_COOKIES_TXT }}
        CONFIG_PY: ${{ secrets.CONFIG_PY }}
      run: |
        echo "$RUTUBE_COOKIES" > rutube_cookies.json
        echo "$TIKTOK_COOKIES" > tiktok_cookies.txt
        echo "$YT_COOKIES" > youtube_cookies.txt
        mkdir -p insta_tok
        cp tiktok_cookies.txt insta_tok/tiktok_cookies.txt
        echo "$CONFIG_PY" > config.py

    - name: Pre-flight check
      run: |
        echo "ðŸ” Pre-flight checks:"
        [ -f youtube_cookies.txt ] && echo "âœ… YouTube cookies: OK" || echo "âš ï¸ YouTube cookies: MISSING"
        [ -f rutube_cookies.json ] && echo "âœ… Rutube cookies: OK" || echo "âš ï¸ Rutube cookies: MISSING"
        [ -f config.py ] && echo "âœ… Config: OK" || echo "âš ï¸ Config: MISSING"
        echo ""
        echo "ðŸ“š Dependency versions:"
        python --version
        pip show yt-dlp | grep Version
        pip show playwright | grep Version
        deno --version 2>/dev/null || echo "âš ï¸ deno: not available (optional)"

    - name: Patch TikTok Uploader
      run: |
        if [ -f "insta_tok/apply_patch.py" ]; then
          python3 insta_tok/apply_patch.py
        fi

    - name: Run Sync with 2-attempt Self-Healing
      id: run_sync
      run: |
        set +e
        
        echo "ðŸš€ [Attempt 1/2] Running sync_production.py..."
        python3 sync_production.py 2>&1 | tee /tmp/sync_attempt1.log
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo ""
          echo "âš ï¸ Attempt 1 failed (Exit Code: $EXIT_CODE)"
          echo "ðŸ“„ Error analysis:"
          echo "---"
          tail -30 /tmp/sync_attempt1.log
          echo "---"
          
          # Diagnose the issue
          if grep -qi "Sign in to confirm\|Sign in to YouTube" /tmp/sync_attempt1.log; then
            echo "âŒ DIAGNOSIS: YouTube authentication expired"
            echo "ðŸ“ ACTION REQUIRED: Update YOUTUBE_COOKIES_TXT secret"
          elif grep -qi "HTTP Error 403\|403 Forbidden" /tmp/sync_attempt1.log; then
            echo "âŒ DIAGNOSIS: IP blocked by YouTube"
            echo "ðŸ“ ACTION REQUIRED: Wait or use proxy"
          elif grep -qi "ModuleNotFoundError\|ImportError" /tmp/sync_attempt1.log; then
            echo "âŒ DIAGNOSIS: Missing Python dependency"
            echo "ðŸ“ ACTION REQUIRED: Check requirements.txt"
          elif grep -qi "playwright.*not found\|browser.*not found" /tmp/sync_attempt1.log; then
            echo "âŒ DIAGNOSIS: Playwright browser issue"
            echo "ðŸ“ Attempting to reinstall Playwright..."
            python -m playwright install --force chromium
          fi
          
          echo ""
          echo "â™»ï¸ [Attempt 2/2] Retrying..."
          
          # Clean cache
          find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null
          find . -type f -name "*.pyc" -delete 2>/dev/null
          
          python3 sync_production.py 2>&1 | tee /tmp/sync_attempt2.log
          EXIT_CODE=$?
        fi
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo ""
          echo "âœ… Sync completed successfully!"
        else
          echo ""
          echo "âŒ Sync failed after 2 attempts (Exit Code: $EXIT_CODE)"
          echo "ðŸ“„ Final error log:"
          echo "---"
          tail -50 /tmp/sync_attempt*.log | tail -50
          echo "---"
          exit $EXIT_CODE
        fi

    - name: Upload metadata cache
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cache-metadata-${{ github.run_id }}
        path: |
          video_metadata_cache.json
          sync_db.sqlite
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload Debug Info (On Failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-info-${{ github.run_id }}
        path: |
          /tmp/sync_*.log
          *.log
          *.png
        retention-days: 7
        if-no-files-found: ignore

    - name: Notify Telegram on Failure
      if: failure()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
      run: |
        if [[ -z "$TELEGRAM_TOKEN" || -z "$TELEGRAM_TO" ]]; then
          exit 0
        fi
        
        ERROR_TYPE="Unknown"
        ERROR_LOG=""
        
        if [ -f "/tmp/sync_attempt2.log" ]; then
          ERROR_LOG=$(tail -20 /tmp/sync_attempt2.log)
        elif [ -f "/tmp/sync_attempt1.log" ]; then
          ERROR_LOG=$(tail -20 /tmp/sync_attempt1.log)
        fi
        
        if echo "$ERROR_LOG" | grep -qi "Sign in to confirm"; then
          ERROR_TYPE="YouTube Auth Failed"
        elif echo "$ERROR_LOG" | grep -qi "403"; then
          ERROR_TYPE="IP Blocked"
        elif echo "$ERROR_LOG" | grep -qi "ModuleNotFoundError"; then
          ERROR_TYPE="Missing Python module"
        fi
        
        MESSAGE="ðŸš¨ Rutube Bot Failed!%0A%0AError: $ERROR_TYPE%0ALogs: https://github.com/crosspostly/fac/actions/runs/${{ github.run_id }}"
        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
        -d chat_id=$TELEGRAM_TO \
        -d text="$MESSAGE" \
        -d parse_mode="Markdown"

    - name: Commit changes
      if: success()
      run: |
        git config --global user.name "Rutube Bot"
        git config --global user.email "bot@github.com"
        
        # Add files if they exist
        git add sync_db.sqlite 2>/dev/null || true
        git add video_metadata_cache.json 2>/dev/null || true
        
        # Only commit if there are changes
        if git diff --cached --quiet; then
          echo "âœ… No changes to commit"
        else
          git commit -m "ðŸ¤– Sync update [skip ci]"
          git pull --rebase origin main
          git push origin main
        fi
