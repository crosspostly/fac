name: Rutube Sync Bot

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */3 * * *'  # Run every 3 hours
  workflow_dispatch:       # Allow manual run button

permissions:
  contents: write          # Allow committing back to repo

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        cache: 'pip' # âš¡ Cache pip dependencies automatically

    - name: Cache deno binary
      uses: actions/cache@v3
      id: deno-cache
      with:
        path: ~/.deno
        key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
        restore-keys: |
          ${{ runner.os }}-deno-

    - name: Install deno (if not cached)
      if: steps.deno-cache.outputs.cache-hit != 'true'
      run: |
        curl -fsSL https://deno.land/x/install/install.sh | sh
        echo "$HOME/.deno/bin" >> $GITHUB_PATH

    - name: Verify deno installation
      run: deno --version

    - name: Cache Playwright Browsers
      uses: actions/cache@v3
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('requirements.txt') }}

    - name: Install System Dependencies (FFmpeg)
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python Dependencies
      run: |
        pip install -r requirements.txt
        # Install browsers only if not cached or ensure they exist
        playwright install chromium
        playwright install-deps

    - name: Restore Secrets (Config & Cookies)
      env:
        RUTUBE_COOKIES: ${{ secrets.RUTUBE_COOKIES_JSON }}
        TIKTOK_COOKIES: ${{ secrets.TIKTOK_COOKIES_TXT }}
        YT_COOKIES: ${{ secrets.YOUTUBE_COOKIES_TXT }}
        CONFIG_PY: ${{ secrets.CONFIG_PY }}
      run: |
        echo "$RUTUBE_COOKIES" > rutube_cookies.json
        echo "$TIKTOK_COOKIES" > tiktok_cookies.txt
        echo "$YT_COOKIES" > youtube_cookies.txt
        cp tiktok_cookies.txt insta_tok/tiktok_cookies.txt
        echo "$CONFIG_PY" > config.py

    - name: Verify YouTube Cookies
      run: |
        if [ ! -f youtube_cookies.txt ] || [ ! -s youtube_cookies.txt ]; then
          echo "âš ï¸ WARNING: youtube_cookies.txt is missing or empty!"
          echo "YouTube will require authentication. This sync may fail."
          echo "To fix: Export YouTube cookies and update YOUTUBE_COOKIES_TXT secret."
        else
          echo "âœ… YouTube cookies found and loaded"
        fi

    - name: Patch TikTok Uploader
      run: |
        python3 insta_tok/apply_patch.py

    - name: Run Sync with Self-Healing (Cached Dependencies)
      id: run_sync
      run: |
        set +e # Don't exit immediately on error
        
        echo "ðŸš€ Attempt 1: Running Sync..."
        python3 sync_production.py
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo "âš ï¸ Attempt 1 failed (Exit Code: $EXIT_CODE)."
          echo "â™»ï¸ Triggering Self-Healing: Clearing caches and reinstalling..."
          
          # Clear caches but keep deno/playwright where possible
          pip cache purge
          rm -rf ~/.cache/pip
          
          # Force reinstall only Python packages (not system deps)
          pip install --force-reinstall --no-cache-dir -r requirements.txt
          playwright install chromium --force
          python3 insta_tok/apply_patch.py
          
          echo "ðŸš€ Attempt 2: Retrying Sync after cleanup..."
          python3 sync_production.py
          EXIT_CODE=$?
        fi
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo "âŒ Attempt 2 failed. Giving up."
          exit $EXIT_CODE
        else
          echo "âœ… Sync successful."
        fi

    - name: Upload Debug Screenshots (On Failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-screenshots
        path: "*.png"
        retention-days: 3

    - name: Notify Telegram on Failure
      if: failure()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
      run: |
        if [[ -z "$TELEGRAM_TOKEN" || -z "$TELEGRAM_TO" ]]; then
          echo "Telegram secrets not set, skipping notification."
          exit 0
        fi
        
        MESSAGE="ðŸš¨ *Rutube Bot Failed!* %0A%0AThe sync process crashed after 2 attempts. Check GitHub Actions logs for details. Common issues:%0Aâ€¢ YouTube cookies expired%0Aâ€¢ GitHub Actions IP blocked%0Aâ€¢ Network timeout"
        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
        -d chat_id=$TELEGRAM_TO \
        -d text="$MESSAGE" \
        -d parse_mode="Markdown"

    - name: Commit and Push DB changes
      if: success() # Only push if sync worked
      run: |
        git config --global user.name "Rutube Bot Action"
        git config --global user.email "bot@github.com"
        
        # Check if DB or cache changed
        if [[ -n $(git status -s sync_db.sqlite) ]] || [[ -n $(git status -s video_metadata_cache.json) ]]; then
          echo "Changes detected in DB/Cache. Committing..."
          git add sync_db.sqlite video_metadata_cache.json 2>/dev/null || true
          git commit -m "ðŸ¤– Sync: Update database and cache [skip ci]" 2>/dev/null || true
          
          # Pull latest changes to avoid out-of-sync errors
          git pull --rebase origin main
          
          git push origin main
        else
          echo "No changes in DB/Cache."
        fi
