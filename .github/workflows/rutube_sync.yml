name: Rutube Sync Bot

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */3 * * *'  # Run every 3 hours
  workflow_dispatch:       # Allow manual run button

permissions:
  contents: write          # Allow committing back to repo

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1
      PIP_NO_INPUT: 1
      DENO_DIR: /home/runner/.deno
      PLAYWRIGHT_BROWSERS_PATH: /home/runner/.cache/ms-playwright

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        cache: 'pip'

    # ========== AGGRESSIVE CACHING START ==========

    - name: Cache deno binary
      uses: actions/cache@v3
      id: deno-cache
      with:
        path: |
          /home/runner/.deno
          /home/runner/.cargo
        key: ${{ runner.os }}-deno-v1-${{ hashFiles('**/deno.lock') }}
        restore-keys: |
          ${{ runner.os }}-deno-v1-
          ${{ runner.os }}-deno-

    - name: Cache APT packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: ffmpeg
        version: 1.0
      continue-on-error: true

    - name: Cache Playwright browsers (CRITICAL)
      uses: actions/cache@v3
      id: playwright-cache
      with:
        path: /home/runner/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    - name: Cache yt-dlp signature cache
      uses: actions/cache@v3
      with:
        path: ~/.cache/yt-dlp
        key: ${{ runner.os }}-ytdlp-cache-${{ github.run_number }}
        restore-keys: |
          ${{ runner.os }}-ytdlp-cache-
      continue-on-error: true

    - name: Cache pip packages (AGGRESSIVE)
      run: |
        mkdir -p ~/.cache/pip-cache
        mkdir -p ~/.config/pip
        echo "[global]" > ~/.config/pip/pip.conf
        echo "cache-dir = ~/.cache/pip-cache" >> ~/.config/pip/pip.conf
        echo "no-deps = false" >> ~/.config/pip/pip.conf
      continue-on-error: true

    - name: Setup deno (if not cached)
      if: steps.deno-cache.outputs.cache-hit != 'true'
      run: |
        curl -fsSL https://deno.land/x/install/install.sh | sh
        echo "$HOME/.deno/bin" >> $GITHUB_PATH
      continue-on-error: true

    - name: Setup deno PATH
      run: echo "$HOME/.deno/bin" >> $GITHUB_PATH
      continue-on-error: true

    - name: Verify deno
      run: deno --version 2>/dev/null || echo "‚ö†Ô∏è Deno not available, yt-dlp will use fallback"
      continue-on-error: true

    - name: Install Python dependencies (use cache)
      run: |
        pip install --prefer-binary -r requirements.txt 2>&1 | head -20

    - name: Install Playwright browsers
      run: |
        playwright install chromium
        sudo playwright install-deps chromium || true
      continue-on-error: true

    - name: Verify Playwright installation
      run: |
        python3 -c "from playwright.sync_api import sync_playwright; print('‚úÖ Playwright OK')" || echo "‚ö†Ô∏è Playwright may have issues"
      continue-on-error: true

    - name: Cache system libraries
      uses: actions/cache@v3
      with:
        path: /home/runner/.local
        key: ${{ runner.os }}-local-libs-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-local-libs-
      continue-on-error: true

    # ========== AGGRESSIVE CACHING END ==========

    - name: Restore Secrets (Config & Cookies)
      env:
        RUTUBE_COOKIES: ${{ secrets.RUTUBE_COOKIES_JSON }}
        TIKTOK_COOKIES: ${{ secrets.TIKTOK_COOKIES_TXT }}
        YT_COOKIES: ${{ secrets.YOUTUBE_COOKIES_TXT }}
        CONFIG_PY: ${{ secrets.CONFIG_PY }}
      run: |
        echo "$RUTUBE_COOKIES" > rutube_cookies.json
        echo "$TIKTOK_COOKIES" > tiktok_cookies.txt
        echo "$YT_COOKIES" > youtube_cookies.txt
        mkdir -p insta_tok
        cp tiktok_cookies.txt insta_tok/tiktok_cookies.txt 2>/dev/null || true
        echo "$CONFIG_PY" > config.py

    - name: Pre-flight check
      run: |
        echo "üîç Pre-flight checks:"
        [ -f youtube_cookies.txt ] && echo "‚úÖ YouTube cookies: OK" || echo "‚ö†Ô∏è YouTube cookies: MISSING"
        [ -f rutube_cookies.json ] && echo "‚úÖ Rutube cookies: OK" || echo "‚ö†Ô∏è Rutube cookies: MISSING"
        [ -f config.py ] && echo "‚úÖ Config: OK" || echo "‚ö†Ô∏è Config: MISSING"
        echo ""
        echo "üìö Dependency versions:"
        python --version
        yt-dlp --version 2>/dev/null || echo "‚ö†Ô∏è yt-dlp: not in PATH"
        deno --version 2>/dev/null || echo "‚ö†Ô∏è deno: not available"
        playwright --version 2>/dev/null || echo "‚ö†Ô∏è playwright CLI: not available"

    - name: Patch TikTok Uploader
      run: |
        if [ -f "insta_tok/apply_patch.py" ]; then
          python3 insta_tok/apply_patch.py
        else
          echo "‚ö†Ô∏è Patch file not found, skipping"
        fi
      continue-on-error: true

    - name: Run Sync with 2-attempt Self-Healing
      id: run_sync
      run: |
        set +e
        
        echo "üöÄ [Attempt 1/2] Running sync_production.py..."
        timeout 300 python3 sync_production.py 2>&1 | tee /tmp/sync.log
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo ""
          echo "‚ö†Ô∏è Attempt 1 failed (Exit Code: $EXIT_CODE)"
          echo "üìÑ Checking error logs..."
          
          # Check for common errors
          if grep -qi "Sign in to confirm" /tmp/sync.log 2>/dev/null || grep -qi "Sign in to confirm" /tmp/ytdlp.log 2>/dev/null; then
            echo "‚ùå Issue: YouTube authentication required"
            echo "üìÑ Action: Update YOUTUBE_COOKIES_TXT secret in GitHub"
          elif grep -qi "HTTP Error 403" /tmp/sync.log 2>/dev/null || grep -qi "403" /tmp/ytdlp.log 2>/dev/null; then
            echo "‚ùå Issue: IP blocked by YouTube"
            echo "üìÑ Action: Use VPN/Proxy (see workflow comments)"
          elif grep -qi "ModuleNotFoundError\|ImportError" /tmp/sync.log 2>/dev/null; then
            echo "‚ùå Issue: Missing Python module"
            echo "üìÑ Action: Check requirements.txt"
          fi
          
          echo ""
          echo "‚ôªÔ∏è [Attempt 2/2] Retrying with aggressive cleanup..."
          
          # Clean Python cache only (NOT system deps)
          find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null
          find . -type f -name "*.pyc" -delete 2>/dev/null
          
          # Reinstall Python deps (but use cache)
          pip install --upgrade --force-reinstall --no-deps yt-dlp 2>&1 | grep -i error || echo "‚úÖ yt-dlp reinstalled"
          
          echo "üöÄ Running sync again..."
          timeout 300 python3 sync_production.py 2>&1 | tee /tmp/sync_retry.log
          EXIT_CODE=$?
        fi
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo ""
          echo "‚úÖ Sync completed successfully!"
        else
          echo ""
          echo "‚ùå Sync failed after 2 attempts (Exit Code: $EXIT_CODE)"
          echo "üìÑ Last 50 lines of log:"
          tail -50 /tmp/sync*.log 2>/dev/null || true
          exit $EXIT_CODE
        fi

    - name: Upload metadata cache
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cache-metadata-${{ github.run_id }}
        path: |
          video_metadata_cache.json
          sync_db.sqlite
        retention-days: 30
        if-no-files-found: warn

    - name: Upload Debug Info (On Failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-info-${{ github.run_id }}
        path: |
          /tmp/*.log
          *.log
          *.png
          *.json
        retention-days: 7
        if-no-files-found: warn

    - name: Notify Telegram on Failure
      if: failure()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
      run: |
        if [[ -z "$TELEGRAM_TOKEN" || -z "$TELEGRAM_TO" ]]; then
          echo "‚ö†Ô∏è Telegram credentials not set, skipping notification"
          exit 0
        fi
        
        ERROR_TYPE="Unknown"
        if grep -qi "Sign in to confirm" /tmp/sync*.log 2>/dev/null; then
          ERROR_TYPE="YouTube Auth Failed - Update cookies"
        elif grep -qi "403" /tmp/sync*.log 2>/dev/null; then
          ERROR_TYPE="IP Blocked - Use proxy"
        elif grep -qi "connection\|timeout" /tmp/sync*.log 2>/dev/null; then
          ERROR_TYPE="Network Error"
        elif grep -qi "ModuleNotFoundError\|ImportError" /tmp/sync*.log 2>/dev/null; then
          ERROR_TYPE="Missing Python module"
        fi
        
        MESSAGE="üö® Rutube Bot Failed!%0A%0AError: $ERROR_TYPE%0ALogs: https://github.com/crosspostly/fac/actions/runs/${{ github.run_id }}"
        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
        -d chat_id=$TELEGRAM_TO \
        -d text="$MESSAGE" \
        -d parse_mode="Markdown" || echo "‚ö†Ô∏è Failed to send Telegram notification"

    - name: Commit changes
      if: success()
      run: |
        git config --global user.name "Rutube Bot"
        git config --global user.email "bot@github.com"
        
        # Check if files exist and have changes
        CHANGED=false
        [ -f sync_db.sqlite ] && git add sync_db.sqlite 2>/dev/null && CHANGED=true
        [ -f video_metadata_cache.json ] && git add video_metadata_cache.json 2>/dev/null && CHANGED=true
        
        if [ "$CHANGED" = true ] && [ -n "$(git diff --cached)" ]; then
          git commit -m "ü§ñ Sync update [skip ci]" || echo "‚ö†Ô∏è Nothing to commit"
          git pull --rebase origin main || echo "‚ö†Ô∏è Pull failed"
          git push origin main || echo "‚ö†Ô∏è Push failed"
        else
          echo "‚úÖ No changes to commit"
        fi
